<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (Bonus Calculator) - SANKO 3+</title>
    
    <!-- Favicon & App Icons (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á v2.3 - Cache Busting & Sizes) -->
    <link rel="icon" type="image/png" href="Gemini_Generated_Image_3c5x4m3c5x4m3c5x-Photoroom.png?v=2.3">
    <link rel="shortcut icon" href="Gemini_Generated_Image_3c5x4m3c5x4m3c5x-Photoroom.png?v=2.3">
    <link rel="apple-touch-icon" sizes="180x180" href="Gemini_Generated_Image_3c5x4m3c5x4m3c5x-Photoroom.png?v=2.3">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Import Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Import Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        input:focus, select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(19, 105, 169, 0.3);
            border-color: #1369a9;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Chart Container Styles */
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col md:flex-row overflow-hidden bg-slate-100">

    <!-- Sidebar (White Theme) -->
    <aside class="bg-white/90 backdrop-blur-xl border-r border-slate-200 text-slate-800 shadow-2xl z-30 
                  w-full md:w-72 flex-shrink-0 flex flex-row md:flex-col justify-between p-4 md:p-6 transition-all duration-300">
        
        <!-- Logo Section (Centered) -->
        <div class="flex items-center justify-center w-full cursor-pointer group" onclick="app.showInput()">
            <div class="relative w-full max-w-[180px]">
                <img src="Gemini_Generated_Image_3c5x4m3c5x4m3c5x-Photoroom.png" 
                     alt="SANKO Logo" 
                     class="h-auto w-full object-contain drop-shadow-sm transition-transform duration-300 group-hover:scale-105"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                
                <!-- Fallback Logo (Dark Text for White BG) -->
                <div class="hidden text-center p-3 border border-slate-200 rounded-xl bg-slate-50">
                    <h1 class="text-xl font-bold text-slate-800">SANKO 3+</h1>
                    <p class="text-xs text-slate-500">Bonus System</p>
                </div>
            </div>
        </div>

        <!-- Desktop Navigation -->
        <div class="hidden md:flex flex-col gap-6 mt-8 flex-1">
             <div class="bg-gradient-to-br from-blue-50 to-white rounded-2xl p-5 border border-blue-100 backdrop-blur-md relative overflow-hidden shadow-sm group hover:shadow-md transition">
                <div class="flex items-start justify-between mb-2 relative z-10">
                    <p class="text-xs text-blue-600 font-bold uppercase tracking-wider">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</p> 
                    <i data-lucide="calendar-check" class="w-4 h-4 text-blue-400 opacity-80"></i>
                </div>
                <div class="flex items-baseline gap-2 relative z-10">
                    <span class="text-4xl font-bold tracking-tight text-slate-800 drop-shadow-sm" id="sidebar-cycle-year">2025</span>
                </div>
                <!-- Connection Status -->
                <div id="db-status" class="mt-3 text-[10px] text-slate-500 flex items-center gap-1.5 opacity-0 transition-opacity">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Cloud Connected
                </div>
            </div>
            
            <nav class="space-y-3">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest px-2">Main Menu</p>
                
                <button onclick="app.showInput()" class="w-full flex items-center gap-3 p-3.5 rounded-xl bg-white hover:bg-blue-50 active:scale-95 transition-all text-left border border-slate-200 shadow-sm group">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-slate-400 group-hover:text-blue-600 transition"></i>
                    <span class="font-medium text-slate-600 group-hover:text-blue-700">‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span>
                </button>

                <button onclick="app.checkAdminAndShowSettings()" class="w-full flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 active:scale-95 transition-all text-left border border-transparent hover:border-blue-100 group text-slate-600">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-blue-600 group-hover:rotate-45 transition-transform duration-500"></i>
                    <span class="font-medium group-hover:text-blue-700">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                </button>

                <button onclick="app.showHistory()" class="w-full flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 active:scale-95 transition-all text-left border border-transparent hover:border-blue-100 group text-slate-600">
                    <i data-lucide="history" class="w-5 h-5 text-slate-400 group-hover:text-blue-600"></i>
                    <span class="font-medium group-hover:text-blue-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</span>
                </button>
            </nav>
        </div>

        <!-- Mobile Header Actions (Dark Icons for White BG) -->
        <div class="flex md:hidden items-center gap-3">
             <div class="text-xs bg-slate-100 border border-slate-200 px-3 py-1.5 rounded-full flex items-center gap-2 text-slate-600">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                ‡∏õ‡∏µ <span id="header-year-mobile">2025</span>
            </div>
            <button onclick="app.toggleMobileMenu()" class="p-2 rounded-full hover:bg-slate-100 text-slate-600 transition">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="hidden md:block text-[10px] text-slate-400 text-center mt-4 pt-4 border-t border-slate-200">
            ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô <span id="footer-version" class="text-slate-600 font-bold">v2.3</span><br>SANKO 3+
        </div>
    </aside>

    <!-- Mobile Menu Overlay (White Theme) -->
    <div id="mobile-menu" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden md:hidden flex-col justify-end transition-opacity" onclick="app.toggleMobileMenu()">
        <div class="bg-white rounded-t-3xl p-6 text-slate-800 space-y-4 shadow-2xl" onclick="event.stopPropagation()">
            <!-- Added Mobile Menu Logo -->
            <div class="flex justify-center mb-6">
                <img src="Gemini_Generated_Image_3c5x4m3c5x4m3c5x-Photoroom.png" 
                     alt="SANKO Logo" 
                     class="h-16 w-auto object-contain drop-shadow-sm"
                     onerror="this.style.display='none';">
            </div>
            
            <button onclick="app.showInput(); app.toggleMobileMenu()" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl flex items-center gap-4 text-lg font-medium text-slate-700">
                <i data-lucide="layout-dashboard" class="w-6 h-6 text-blue-600"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            </button>
            <button onclick="app.checkAdminAndShowSettings(); app.toggleMobileMenu()" class="w-full p-4 hover:bg-slate-50 rounded-2xl flex items-center gap-4 text-lg text-slate-600">
                <i data-lucide="settings" class="w-6 h-6 text-slate-400"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>
             <button onclick="app.showHistory(); app.toggleMobileMenu()" class="w-full p-4 hover:bg-slate-50 rounded-2xl flex items-center gap-4 text-lg text-slate-600">
                <i data-lucide="history" class="w-6 h-6 text-slate-400"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
            </button>
            <div class="text-center text-xs text-slate-400 pt-4">
                ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô <span id="mobile-menu-version">v2.3</span><br>SANKO 3+
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative scroll-smooth p-4 md:p-8">
        <div class="max-w-5xl mx-auto pb-12">

            <!-- PAGE: INPUT -->
            <div id="page-input" class="fade-in space-y-6">
                <div class="md:hidden h-2"></div>
                
                <!-- Section 1: Employee Data -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-blue-100 flex items-center gap-3">
                        <div class="p-2 bg-white text-blue-600 rounded-xl shadow-sm"><i data-lucide="user" class="w-5 h-5"></i></div>
                        <h2 class="font-bold text-slate-800 text-lg">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô</h2>
                    </div>
                    <div class="p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó) <span class="text-red-500">*</span></label>
                            <input type="number" id="salary" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15000">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="position-allowance" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0" value="0">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-600 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label>
                            <input type="date" id="start-date" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white transition">
                            <p class="text-xs text-slate-400 mt-2 flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Performance -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 px-6 py-4 border-b border-emerald-100 flex items-center gap-3">
                        <div class="p-2 bg-white text-emerald-600 rounded-xl shadow-sm"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></div>
                        <h2 class="font-bold text-slate-800 text-lg">2. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
                    </div>
                    <div class="p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">‡πÄ‡∏Å‡∏£‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• (Grade)</label>
                            <div class="relative">
                                <select id="grade" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white appearance-none cursor-pointer"></select>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-4 top-4 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° (‡∏ß‡∏±‡∏ô)</label>
                            <input type="number" id="leave-days" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white transition" placeholder="0" value="0">
                            <p class="text-xs text-emerald-600 mt-2 font-medium flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> 0 ‡∏ß‡∏±‡∏ô = ‡πÑ‡∏î‡πâ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô (Perfect Attendance)</p>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Deductions -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-rose-50 to-orange-50 px-6 py-4 border-b border-rose-100 flex items-center gap-3">
                         <div class="p-2 bg-white text-rose-600 rounded-xl shadow-sm"><i data-lucide="alert-octagon" class="w-5 h-5"></i></div>
                        <h2 class="font-bold text-slate-800 text-lg">3. ‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏©‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ (Deductions)</h2>
                    </div>
                    <div class="p-6 md:p-8 space-y-6">
                        <div class="flex items-center gap-4 p-4 bg-rose-50 rounded-2xl border border-rose-100 cursor-pointer hover:bg-rose-100 transition" onclick="document.getElementById('is-suspended').click()">
                            <input type="checkbox" id="is-suspended" class="w-6 h-6 text-rose-600 rounded focus:ring-rose-500 border-gray-300 cursor-pointer pointer-events-none">
                            <label class="text-sm font-bold text-rose-800 cursor-pointer select-none flex-1">‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡∏π‡∏Å‡∏™‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏´‡∏±‡∏Å‡πÇ‡∏ö‡∏ô‡∏±‡∏™ <span id="suspend-percent-label">50</span>%)</label>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                                <div class="relative">
                                    <input type="number" id="warning-count" class="w-full pl-4 pr-10 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-rose-400 focus:ring-rose-200 placeholder-slate-300" placeholder="0" value="0">
                                    <span class="absolute right-3 top-2.5 text-slate-400 text-xs font-medium">‡πÉ‡∏ö</span>
                                </div>
                                <p class="text-[10px] text-rose-500 mt-2 font-medium text-right">‡πÉ‡∏ö‡∏•‡∏∞ <span id="warning-amount-label">1,000</span> ‡∏ö.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <label class="block text-xs font-bold text-slate-600 mb-3 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô</label>
                                <div class="relative">
                                    <input type="number" id="absent-days" class="w-full pl-4 pr-10 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-rose-400 focus:ring-rose-200 placeholder-slate-300" placeholder="0" value="0">
                                    <span class="absolute right-3 top-2.5 text-slate-400 text-xs font-medium">‡∏ß‡∏±‡∏ô</span>
                                </div>
                                <p class="text-[10px] text-rose-500 mt-2 font-medium text-right">‡∏´‡∏±‡∏Å <span id="absent-percent-label">3</span>% ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <label class="block text-xs font-bold text-slate-600 mb-3 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏™‡∏≤‡∏¢</label>
                                <div class="relative">
                                    <input type="number" id="late-times" class="w-full pl-4 pr-10 py-2.5 border border-slate-200 rounded-xl text-sm focus:border-rose-400 focus:ring-rose-200 placeholder-slate-300" placeholder="0" value="0">
                                    <span class="absolute right-3 top-2.5 text-slate-400 text-xs font-medium">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                                </div>
                                <p class="text-[10px] text-rose-500 mt-2 font-medium text-right">‡∏´‡∏±‡∏Å <span id="late-percent-label">3</span>% ‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 pt-2">
                    <button onclick="app.clearInputs()" class="flex-1 bg-white hover:bg-slate-50 border border-slate-300 text-slate-600 font-bold py-4 rounded-2xl shadow-sm transition active:scale-[0.98] flex items-center justify-center gap-2">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                    </button>
                    <button id="btn-calculate" onclick="app.calculateBonus()" class="flex-[2] bg-[#1369a9] hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-blue-200 transform active:scale-[0.98] transition-all flex items-center justify-center gap-3 text-lg group">
                        <i data-lucide="calculator" class="w-6 h-6 group-hover:rotate-12 transition"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™
                    </button>
                </div>
            </div>

            <!-- PAGE: RESULT (Infographic Style) -->
            <div id="page-result" class="hidden slide-in-right space-y-6">
                
                <button onclick="app.showInput()" class="text-slate-500 hover:text-[#1369a9] flex items-center gap-2 font-semibold text-sm transition py-2 px-4 rounded-lg hover:bg-white border border-transparent hover:border-slate-200 w-fit">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>

                <!-- 1. Hero Card: Net Bonus -->
                <div class="bg-gradient-to-br from-[#1369a9] to-indigo-900 rounded-[2rem] shadow-2xl text-white p-8 relative overflow-hidden border border-white/10">
                    <div class="absolute -right-10 -top-10 opacity-10"><i data-lucide="coins" class="w-64 h-64"></i></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6">
                        <div>
                            <p class="text-blue-200 text-sm font-bold uppercase tracking-widest mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Bonus)</p>
                            <h2 class="text-5xl md:text-7xl font-bold flex items-baseline gap-3">
                                <span id="final-bonus-display">0.00</span>
                                <span class="text-2xl font-medium text-blue-300">THB</span>
                            </h2>
                        </div>
                        <div class="text-right">
                            <div class="bg-white/10 backdrop-blur-md px-4 py-2 rounded-lg border border-white/10 inline-block mb-1">
                                <span class="text-blue-100 text-xs">‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span>
                                <span class="block text-xl font-bold" id="base-salary-display">0</span>
                            </div>
                            <div class="text-sm text-blue-200 mt-1">
                                x <span id="total-months-display" class="font-bold text-white text-lg">0.00</span> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Charts Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Composition Chart -->
                    <div class="md:col-span-1 bg-white rounded-3xl p-6 shadow-sm border border-slate-200 flex flex-col">
                        <h3 class="text-slate-700 font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ö‡∏ô‡∏±‡∏™
                        </h3>
                        <div class="chart-container flex-1">
                            <canvas id="compositionChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 text-center mt-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</p>
                    </div>

                    <!-- Deduction Analysis -->
                    <div class="md:col-span-2 bg-white rounded-3xl p-6 shadow-sm border border-slate-200 flex flex-col">
                        <h3 class="text-slate-700 font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-rose-500"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (Deductions)
                        </h3>
                        <div class="chart-container flex-1">
                            <canvas id="deductionChart"></canvas>
                        </div>
                        <div id="no-deduction-msg" class="hidden text-center text-emerald-500 font-bold py-10 bg-emerald-50 rounded-xl">
                            üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô
                        </div>
                    </div>
                </div>

                <!-- 3. Detailed Breakdown Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Rate Factors -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (Multipliers)</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-500 text-sm">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Fixed)</span>
                                <span class="font-mono font-bold text-slate-700">1.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-emerald-50/50 rounded-xl">
                                <span class="text-slate-500 text-sm">‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô <span id="attend-detail" class="text-xs text-emerald-500"></span></span>
                                <span class="font-mono font-bold text-emerald-600" id="attend-rate-display">0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-50/50 rounded-xl">
                                <span class="text-slate-500 text-sm">‡∏ú‡∏•‡∏á‡∏≤‡∏ô <span id="perf-detail" class="text-xs text-blue-500"></span></span>
                                <span class="font-mono font-bold text-blue-600" id="perf-rate-display">0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-indigo-50 border border-indigo-100 rounded-xl mt-2">
                                <span class="text-indigo-900 font-bold text-sm">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏°</span>
                                <span class="font-mono font-bold text-indigo-700 text-lg" id="sum-rate-display">0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-800 text-white rounded-xl">
                                <div class="flex flex-col">
                                    <span class="text-xs text-slate-300">‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô (Service Rate)</span>
                                    <span class="text-[10px] text-slate-400" id="service-date-detail">-</span>
                                </div>
                                <span class="font-mono font-bold text-xl text-yellow-400" id="service-rate-display">x 1.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Adjustments -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö (Adjustments)</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg"><i data-lucide="gift" class="w-4 h-4"></i></div>
                                    <span class="text-sm font-medium text-slate-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                                </div>
                                <span class="font-bold text-emerald-600">+<span id="special-money-display">0</span></span>
                            </div>
                            
                            <div id="perfect-attendance-row" class="hidden flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg"><i data-lucide="star" class="w-4 h-4"></i></div>
                                    <span class="text-sm font-medium text-slate-600">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô (Perfect Attendance)</span>
                                </div>
                                <span class="font-bold text-emerald-600">+<span id="perfect-attendance-display">0</span></span>
                            </div>

                            <div id="deductions-list" class="space-y-2 border-t pt-2 mt-2">
                                <!-- JS Populated -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: SETTINGS (Admin) -->
            <div id="page-settings" class="hidden fade-in">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="app.showInput()" class="text-slate-500 hover:text-[#1369a9] flex items-center gap-2 font-semibold text-sm transition"><div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shadow-sm"><i data-lucide="arrow-left" class="w-4 h-4"></i></div>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                    <h2 class="text-2xl font-bold text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <div class="w-10"></div> 
                </div>

                <div class="space-y-8">
                    <div class="bg-blue-50/50 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-sm border border-blue-200">
                        <h3 class="font-bold text-blue-900 mb-6 flex items-center gap-3 text-lg">
                            <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="database" class="w-5 h-5"></i></div>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Supabase)
                        </h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div><label class="block text-sm font-medium text-slate-700 mb-2">Supabase URL</label><input type="text" id="conf-supabase-url" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-100 text-slate-500 focus:outline-none cursor-default" readonly></div>
                            <div><label class="block text-sm font-medium text-slate-700 mb-2">Supabase Key</label><div class="relative"><input type="text" id="conf-supabase-key" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-100 text-slate-500 focus:outline-none cursor-default truncate pr-10" readonly><div class="absolute right-3 top-3 text-slate-400"><i data-lucide="lock" class="w-5 h-5"></i></div></div></div>
                        </div>
                    </div>

                    <!-- Config Forms -->
                    <div class="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div class="p-2 bg-indigo-100 text-indigo-600 rounded-lg"><i data-lucide="calendar" class="w-5 h-5"></i></div>‡∏£‡∏≠‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h3>
                        <div><label class="block text-sm font-medium text-slate-700 mb-2">‡∏õ‡∏µ‡∏£‡∏≠‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™</label><input type="number" id="conf-year" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-100 transition" placeholder="2025"></div>
                    </div>

                    <div class="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg"><i data-lucide="star" class="w-5 h-5"></i></div>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏£‡∏î</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><label class="block text-xs font-bold text-slate-500 mb-2">Grade A</label><input type="number" step="0.1" id="conf-rate-a" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-white"></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><label class="block text-xs font-bold text-slate-500 mb-2">Grade B</label><input type="number" step="0.1" id="conf-rate-b" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-white"></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><label class="block text-xs font-bold text-slate-500 mb-2">Grade C</label><input type="number" step="0.1" id="conf-rate-c" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-white"></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><label class="block text-xs font-bold text-slate-500 mb-2">Grade D</label><input type="number" step="0.1" id="conf-rate-d" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-white"></div>
                        </div>
                    </div>

                    <div class="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="clock" class="w-5 h-5"></i></div>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
                        <div class="space-y-3" id="conf-attendance-container"></div>
                    </div>

                    <div class="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div class="p-2 bg-pink-100 text-pink-600 rounded-lg"><i data-lucide="gift" class="w-5 h-5"></i></div>‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><label class="text-sm font-medium text-slate-600">‡∏Å‡∏•‡∏∏‡πà‡∏° 4</label><input type="number" id="conf-money-4" class="w-32 px-2 py-1 border border-slate-300 rounded text-right"></div>
                            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><label class="text-sm font-medium text-slate-600">‡∏Å‡∏•‡∏∏‡πà‡∏° 3</label><input type="number" id="conf-money-3" class="w-32 px-2 py-1 border border-slate-300 rounded text-right"></div>
                            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><label class="text-sm font-medium text-slate-600">‡∏Å‡∏•‡∏∏‡πà‡∏° 2</label><input type="number" id="conf-money-2" class="w-32 px-2 py-1 border border-slate-300 rounded text-right"></div>
                            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><label class="text-sm font-medium text-slate-600">‡∏Å‡∏•‡∏∏‡πà‡∏° 1</label><input type="number" id="conf-money-1" class="w-32 px-2 py-1 border border-slate-300 rounded text-right"></div>
                        </div>
                        <div class="flex items-center justify-between border-t border-slate-100 pt-4 mt-4 bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                            <label class="text-sm text-emerald-800 font-bold flex items-center gap-2"><i data-lucide="star" class="w-4 h-4"></i> ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏© (Perfect Attendance)</label>
                            <input type="number" id="conf-money-perfect" class="w-36 px-3 py-2 border border-emerald-200 rounded-lg text-right text-emerald-700 font-bold bg-white focus:ring-2 focus:ring-emerald-200">
                        </div>
                    </div>

                     <div class="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-3 text-lg"><div class="p-2 bg-rose-100 text-rose-600 rounded-lg"><i data-lucide="alert-octagon" class="w-5 h-5"></i></div>‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏©</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label class="block text-xs font-bold text-slate-500 mb-2">‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (%)</label><input type="number" step="0.5" id="conf-deduct-absent" class="w-full px-4 py-3 border border-slate-200 rounded-xl"></div>
                             <div><label class="block text-xs font-bold text-slate-500 mb-2">‡∏´‡∏±‡∏Å‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (%)</label><input type="number" step="0.5" id="conf-deduct-late" class="w-full px-4 py-3 border border-slate-200 rounded-xl"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-2">‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="conf-deduct-warn" class="w-full px-4 py-3 border border-slate-200 rounded-xl"></div>
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4 pb-8">
                        <button onclick="app.resetConfig()" class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</button>
                        <button onclick="app.saveConfig()" class="flex-1 px-6 py-4 bg-[#1369a9] text-white font-bold rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>

            <!-- PAGE: HISTORY -->
            <div id="page-history" class="hidden fade-in">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="app.showInput()" class="text-slate-500 hover:text-indigo-600 flex items-center gap-2 font-semibold text-sm transition"><div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shadow-sm"><i data-lucide="arrow-left" class="w-4 h-4"></i></div>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                    <h2 class="text-2xl font-bold text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó (Version History)</h2>
                    <div class="w-10"></div> 
                </div>
                <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div id="history-list" class="divide-y divide-slate-100"></div>
                    <div id="empty-history" class="p-12 text-center text-slate-400 hidden"><i data-lucide="clock" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</p></div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const app = {
            // Default Config
            defaultConfig: {
                version: '2.3', // UPDATED
                year: 2025,
                rates: { A: 1.8, B: 1.5, C: 1.2, D: 0.6, F: 0 },
                specialMoney: [4000, 3000, 2000, 1000], 
                perfectAttendance: 2000,
                attendanceTiers: [
                    { limit: 0, rate: 1.8 }, { limit: 3, rate: 1.65 }, { limit: 6, rate: 1.5 },
                    { limit: 9, rate: 1.2 }, { limit: 12, rate: 0.9 }, { limit: 15, rate: 0.6 }, { limit: 20, rate: 0.3 }
                ],
                deductions: { absentPercent: 3, latePercent: 3, warningAmount: 1000, suspendPercent: 50 },
                history: [
                    { version: '2.3', date: new Date().toISOString(), details: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Favicon ‡πÅ‡∏ö‡∏ö Cache Busting ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' },
                    { version: '2.2', date: '2025-01-03T05:40:00.000Z', details: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Shortcut/Apple Touch Icon' },
                    { version: '2.1', date: '2025-01-03T05:30:00.000Z', details: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Favicon ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π Mobile' },
                    { version: '2.0', date: '2025-01-03T05:00:00.000Z', details: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß (White Theme) ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ' },
                    { version: '1.9', date: '2025-01-03T04:30:00.000Z', details: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß (White Theme)' },
                    { version: '1.8', date: '2025-01-03T04:00:00.000Z', details: '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠' },
                    { version: '1.7', date: '2025-01-03T03:30:00.000Z', details: '‡πÄ‡∏û‡∏¥‡πà‡∏° Favicon ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô README' },
                    { version: '1.6', date: '2025-01-03T03:00:00.000Z', details: '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Dashboard Infographic ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•' },
                    { version: '1.5', date: '2025-01-03T02:30:00.000Z', details: '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Read-only)' },
                    { version: '1.4', date: '2025-01-03T02:00:00.000Z', details: 'Hardcoded Supabase credentials and removed LocalStorage' },
                    { version: '1.3', date: '2025-01-03T00:00:00.000Z', details: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase Database' },
                    { version: '1.2', date: '2025-01-02T00:00:00.000Z', details: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢' },
                    { version: '1.1', date: '2025-01-01T00:00:00.000Z', details: '‡∏õ‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå Sidebar ‡πÄ‡∏õ‡πá‡∏ô Glassmorphism, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' }
                ],
                supabaseUrl: 'https://uztnwpyfmzhxybwbhvat.supabase.co', 
                supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6dG53cHlmbXpoeHlid2JodmF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MjU3MjksImV4cCI6MjA4NDMwMTcyOX0.wsUeRzjE1YreKFMl8I2OpzxY09WbVFLUWEs2IENfgVs'
            },
            
            config: {},
            supabase: null,
            charts: {}, // Store Chart instances

            data: { salary: 0, positionAllowance: 0, startDate: '', grade: 'A', leaveDays: 0, isSuspended: false, warningCount: 0, absentDays: 0, lateTimes: 0 },

            init() {
                this.loadConfig();
                this.updateLabels();
                this.generateGradeOptions();
                this.setupEnterKey();
                lucide.createIcons();
                setTimeout(() => { const salInput = document.getElementById('salary'); if(salInput) salInput.focus(); }, 100);
            },

            initSupabase() {
                if (this.config.supabaseUrl && this.config.supabaseKey) {
                    try {
                        this.supabase = window.supabase.createClient(this.config.supabaseUrl, this.config.supabaseKey);
                        document.getElementById('db-status').style.opacity = '1';
                        this.fetchConfigFromSupabase();
                    } catch (e) { console.error('Supabase init error:', e); document.getElementById('db-status').style.opacity = '0'; }
                }
            },

            toggleMobileMenu() {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden'); menu.classList.toggle('flex');
            },

            checkAdminAndShowSettings() {
                this.showPasswordPrompt((success) => { if (success) this.showSettings(); });
            },

            showPasswordPrompt(callback) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-overlay z-50 flex items-center justify-center fade-in px-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl scale-100 border border-slate-100">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2.5 bg-blue-100 text-blue-600 rounded-full"><i data-lucide="lock" class="w-6 h-6"></i></div>
                            <h3 class="text-lg font-bold text-slate-800">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                        </div>
                        <input type="password" id="admin-password-input" class="w-full px-4 py-3 border border-slate-300 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none text-center tracking-widest text-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <div class="flex gap-3">
                            <button id="modal-cancel" class="flex-1 px-4 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="modal-ok" class="flex-1 px-4 py-3 bg-[#1369a9] text-white font-bold rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200 text-sm">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
                lucide.createIcons();
                const input = modal.querySelector('#admin-password-input');
                const okBtn = modal.querySelector('#modal-ok');
                const cancelBtn = modal.querySelector('#modal-cancel');
                setTimeout(() => input.focus(), 50);
                const close = () => { modal.classList.add('opacity-0'); setTimeout(() => modal.remove(), 200); };
                const attemptLogin = () => {
                    if (input.value === 'admin') { close(); callback(true); } else {
                        input.classList.add('border-red-500', 'ring-2', 'ring-red-200'); input.value = ''; input.placeholder = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!'; setTimeout(() => input.focus(), 100);
                    }
                };
                okBtn.onclick = attemptLogin;
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptLogin(); });
                cancelBtn.onclick = () => { close(); callback(false); };
            },

            loadConfig() {
                this.config = JSON.parse(JSON.stringify(this.defaultConfig));
                this.updateYearDisplays(this.config.year);
                this.updateVersionDisplays(this.config.version);
                if(this.config.supabaseUrl && this.config.supabaseKey) this.initSupabase();
            },

            async fetchConfigFromSupabase() {
                if(!this.supabase) return;
                const { data, error } = await this.supabase.from('bonus_config').select('config').eq('id', 1).single();
                if (data && data.config) {
                    const cloudConfig = data.config;
                    cloudConfig.supabaseUrl = this.defaultConfig.supabaseUrl;
                    cloudConfig.supabaseKey = this.defaultConfig.supabaseKey;
                    this.config = cloudConfig;
                    this.populateSettingsForm();
                    this.updateYearDisplays(this.config.year);
                    this.updateLabels();
                }
            },

            updateYearDisplays(year) {
                const sidebarYear = document.getElementById('sidebar-cycle-year');
                if(sidebarYear) sidebarYear.innerText = year;
                const headerYearMobile = document.getElementById('header-year-mobile');
                if(headerYearMobile) headerYearMobile.innerText = year;
            },

            updateVersionDisplays(ver) {
                const footerVer = document.getElementById('footer-version');
                if(footerVer) footerVer.innerText = 'v' + ver;
                const mobileMenuVer = document.getElementById('mobile-menu-version');
                if(mobileMenuVer) mobileMenuVer.innerText = 'v' + ver;
            },

            async saveConfig() {
                this.config.year = parseInt(document.getElementById('conf-year').value) || 2025;
                // ... (reading other config values) ...
                this.config.rates.A = parseFloat(document.getElementById('conf-rate-a').value) || 0;
                this.config.rates.B = parseFloat(document.getElementById('conf-rate-b').value) || 0;
                this.config.rates.C = parseFloat(document.getElementById('conf-rate-c').value) || 0;
                this.config.rates.D = parseFloat(document.getElementById('conf-rate-d').value) || 0;
                this.config.specialMoney[0] = parseFloat(document.getElementById('conf-money-4').value) || 0;
                this.config.specialMoney[1] = parseFloat(document.getElementById('conf-money-3').value) || 0;
                this.config.specialMoney[2] = parseFloat(document.getElementById('conf-money-2').value) || 0;
                this.config.specialMoney[3] = parseFloat(document.getElementById('conf-money-1').value) || 0;
                this.config.perfectAttendance = parseFloat(document.getElementById('conf-money-perfect').value) || 0;
                this.config.deductions.absentPercent = parseFloat(document.getElementById('conf-deduct-absent').value) || 0;
                this.config.deductions.latePercent = parseFloat(document.getElementById('conf-deduct-late').value) || 0;
                this.config.deductions.warningAmount = parseFloat(document.getElementById('conf-deduct-warn').value) || 0;

                // Sync History
                const currentVer = this.config.version;
                if (this.config.history[0].details !== `Updated settings (v${currentVer})`) {
                     this.config.history.unshift({ version: currentVer, date: new Date().toISOString(), details: `Updated settings (v${currentVer})` });
                }

                // Cloud Save
                let cloudMsg = '';
                if(this.supabase) {
                    const { error } = await this.supabase.from('bonus_config').upsert({ id: 1, config: this.config });
                    if(!error) cloudMsg = '<br><span class="text-green-600 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                    else cloudMsg = `<br><span class="text-red-500">Cloud Error: ${error.message}</span>`;
                }

                this.updateYearDisplays(this.config.year);
                this.updateLabels();
                this.generateGradeOptions();
                this.showModal(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß${cloudMsg}`, 'alert', () => this.showInput());
            },

            resetConfig() {
                this.showModal('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', 'confirm', async () => {
                    this.config = JSON.parse(JSON.stringify(this.defaultConfig));
                    if(this.supabase) await this.supabase.from('bonus_config').upsert({ id: 1, config: this.config });
                    this.populateSettingsForm();
                    this.updateYearDisplays(this.config.year);
                    this.updateVersionDisplays('2.3');
                    this.showModal('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                });
            },

            populateSettingsForm() {
                document.getElementById('conf-year').value = this.config.year;
                document.getElementById('conf-supabase-url').value = this.config.supabaseUrl || '';
                document.getElementById('conf-supabase-key').value = this.config.supabaseKey || '';
                document.getElementById('conf-rate-a').value = this.config.rates.A;
                document.getElementById('conf-rate-b').value = this.config.rates.B;
                document.getElementById('conf-rate-c').value = this.config.rates.C;
                document.getElementById('conf-rate-d').value = this.config.rates.D;
                document.getElementById('conf-money-4').value = this.config.specialMoney[0];
                document.getElementById('conf-money-3').value = this.config.specialMoney[1];
                document.getElementById('conf-money-2').value = this.config.specialMoney[2];
                document.getElementById('conf-money-1').value = this.config.specialMoney[3];
                document.getElementById('conf-money-perfect').value = this.config.perfectAttendance;
                document.getElementById('conf-deduct-absent').value = this.config.deductions.absentPercent;
                document.getElementById('conf-deduct-late').value = this.config.deductions.latePercent;
                document.getElementById('conf-deduct-warn').value = this.config.deductions.warningAmount;
                const tierContainer = document.getElementById('conf-attendance-container');
                tierContainer.innerHTML = '';
                this.config.attendanceTiers.forEach((tier, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 tier-row';
                    div.innerHTML = `<span class="text-sm text-gray-600 w-28">‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô):</span><input type="number" class="w-20 px-3 py-2 border border-slate-200 rounded-lg text-center tier-limit" value="${tier.limit}"><span class="text-sm text-gray-600">‡πÑ‡∏î‡πâ Rate:</span><input type="number" step="0.05" class="w-20 px-3 py-2 border border-slate-200 rounded-lg text-center tier-rate" value="${tier.rate}">`;
                    tierContainer.appendChild(div);
                });
            },

            renderHistory() {
                const list = document.getElementById('history-list');
                const empty = document.getElementById('empty-history');
                list.innerHTML = '';
                if (!this.config.history || this.config.history.length === 0) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');
                this.config.history.forEach((item) => {
                    const date = new Date(item.date).toLocaleString('th-TH', { year: '2-digit', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const div = document.createElement('div');
                    div.className = 'p-5 flex items-start gap-4 hover:bg-slate-50 transition';
                    div.innerHTML = `<div class="flex-shrink-0 w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 font-bold border border-indigo-100">v${item.version}</div><div class="flex-1"><div class="flex justify-between items-start"><h4 class="font-bold text-slate-800">${item.details}</h4><span class="text-xs text-slate-400 font-medium">${date}</span></div><p class="text-sm text-slate-500 mt-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p></div>`;
                    list.appendChild(div);
                });
            },

            updateLabels() {
                document.getElementById('suspend-percent-label').innerText = this.config.deductions.suspendPercent;
                document.getElementById('warning-amount-label').innerText = this.config.deductions.warningAmount.toLocaleString();
                document.getElementById('absent-percent-label').innerText = this.config.deductions.absentPercent;
                document.getElementById('late-percent-label').innerText = this.config.deductions.latePercent;
            },

            generateGradeOptions() {
                const sel = document.getElementById('grade');
                const currentVal = sel.value || 'A';
                sel.innerHTML = `<option value="A">A (Rate ${this.config.rates.A}) - ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</option><option value="B">B (Rate ${this.config.rates.B}) - ‡∏î‡∏µ‡∏°‡∏≤‡∏Å</option><option value="C">C (Rate ${this.config.rates.C}) - ‡∏î‡∏µ</option><option value="D">D (Rate ${this.config.rates.D}) - ‡∏û‡∏≠‡πÉ‡∏ä‡πâ</option><option value="F">F (Rate ${this.config.rates.F}) - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</option>`;
                sel.value = currentVal;
            },

            setupEnterKey() {
                const inputOrder = ['salary', 'position-allowance', 'start-date', 'grade', 'leave-days', 'btn-calculate'];
                inputOrder.forEach((id, index) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('keydown', function(event) {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                const nextIndex = index + 1;
                                if (nextIndex < inputOrder.length) {
                                    const nextId = inputOrder[nextIndex];
                                    const nextElement = document.getElementById(nextId);
                                    if (nextElement) { nextElement.focus(); if (nextElement.tagName === 'INPUT') nextElement.select(); }
                                }
                            }
                        });
                    }
                });
            },

            getServiceYearRate(dateStr) {
                if (!dateStr) return 0;
                const start = new Date(dateStr);
                const cy = this.config.year;
                const prevY = cy - 1;
                const d = (y, m, d) => new Date(y, m-1, d);
                if (start < d(prevY, 11, 16)) return 1.00; if (start <= d(prevY, 12, 15)) return 0.91; if (start <= d(cy, 1, 15)) return 0.83; if (start <= d(cy, 2, 15)) return 0.75; if (start <= d(cy, 3, 15)) return 0.66; if (start <= d(cy, 4, 15)) return 0.58; if (start <= d(cy, 5, 15)) return 0.51; if (start <= d(cy, 6, 15)) return 0.41; if (start <= d(cy, 7, 15)) return 0.33; return 0; 
            },

            getSpecialMoney(dateStr) {
                if (!dateStr) return 0;
                const start = new Date(dateStr);
                const cy = this.config.year;
                const prevY = cy - 1;
                const d = (y, m, d) => new Date(y, m-1, d);
                if (start < d(prevY, 11, 16)) return this.config.specialMoney[0]; if (start <= d(cy, 7, 15)) return this.config.specialMoney[1]; if (start <= d(cy, 9, 15)) return this.config.specialMoney[2]; if (start <= d(cy, 11, 30)) return this.config.specialMoney[3]; return 0; 
            },

            getAttendanceRate(days) {
                for (let tier of this.config.attendanceTiers) { if (days <= tier.limit) return tier.rate; } return 0;
            },

            getPerformanceRate(grade) { return this.config.rates[grade] || 0; },

            silentClear() {
                document.getElementById('salary').value = '';
                document.getElementById('position-allowance').value = '0';
                document.getElementById('start-date').value = '';
                document.getElementById('grade').value = 'A';
                document.getElementById('leave-days').value = '0';
                document.getElementById('is-suspended').checked = false;
                document.getElementById('warning-count').value = '0';
                document.getElementById('absent-days').value = '0';
                document.getElementById('late-times').value = '0';
                this.data = { salary: 0, positionAllowance: 0, startDate: '', grade: 'A', leaveDays: 0, isSuspended: false, warningCount: 0, absentDays: 0, lateTimes: 0 };
            },

            clearInputs() {
                this.showModal('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', 'confirm', () => { this.silentClear(); document.getElementById('salary').focus(); });
            },

            calculateBonus() {
                this.data.salary = parseFloat(document.getElementById('salary').value) || 0;
                this.data.positionAllowance = parseFloat(document.getElementById('position-allowance').value) || 0;
                this.data.startDate = document.getElementById('start-date').value;
                this.data.grade = document.getElementById('grade').value;
                this.data.leaveDays = parseFloat(document.getElementById('leave-days').value) || 0;
                this.data.isSuspended = document.getElementById('is-suspended').checked;
                this.data.warningCount = parseFloat(document.getElementById('warning-count').value) || 0;
                this.data.absentDays = parseFloat(document.getElementById('absent-days').value) || 0;
                this.data.lateTimes = parseFloat(document.getElementById('late-times').value) || 0;

                if (!this.data.startDate) { this.showModal('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'); return; }

                const calculationData = { ...this.data };
                const FIXED_BONUS = 1.0;
                const attendRate = this.getAttendanceRate(calculationData.leaveDays);
                const perfRate = this.getPerformanceRate(calculationData.grade);
                const serviceRate = this.getServiceYearRate(calculationData.startDate);
                
                const sumRates = FIXED_BONUS + attendRate + perfRate;
                const totalMonths = sumRates * serviceRate;
                const baseSalaryTotal = calculationData.salary + calculationData.positionAllowance;
                let grossBonus = totalMonths * baseSalaryTotal;
                const specialMoney = this.getSpecialMoney(calculationData.startDate);
                let perfectAttendanceBonus = 0;
                if (calculationData.leaveDays === 0) perfectAttendanceBonus = this.config.perfectAttendance || 0;

                let deductions = [];
                let totalDeductionAmount = 0;
                let absentDeduct = 0, lateDeduct = 0, warningDeduct = 0, suspendDeduct = 0;

                if (calculationData.absentDays > 0) {
                    const pct = this.config.deductions.absentPercent / 100;
                    absentDeduct = grossBonus * (pct * calculationData.absentDays);
                    deductions.push({ label: `‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (${calculationData.absentDays} ‡∏ß‡∏±‡∏ô)`, amount: absentDeduct });
                    totalDeductionAmount += absentDeduct;
                }
                if (calculationData.lateTimes > 0) {
                    const pct = this.config.deductions.latePercent / 100;
                    lateDeduct = grossBonus * (pct * calculationData.lateTimes);
                    deductions.push({ label: `‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (${calculationData.lateTimes} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`, amount: lateDeduct });
                    totalDeductionAmount += lateDeduct;
                }
                if (calculationData.warningCount > 0) {
                    warningDeduct = this.config.deductions.warningAmount * calculationData.warningCount;
                    deductions.push({ label: `‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (${calculationData.warningCount} ‡πÉ‡∏ö)`, amount: warningDeduct });
                    totalDeductionAmount += warningDeduct;
                }

                let netBonus = grossBonus + specialMoney + perfectAttendanceBonus - totalDeductionAmount;
                if (calculationData.isSuspended) {
                    const pct = this.config.deductions.suspendPercent / 100;
                    suspendDeduct = netBonus * pct;
                    deductions.push({ label: `‡∏ñ‡∏π‡∏Å‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô (${this.config.deductions.suspendPercent}%)`, amount: suspendDeduct });
                    totalDeductionAmount += suspendDeduct;
                    netBonus = netBonus * (1 - pct);
                }
                if (netBonus < 0) netBonus = 0;

                this.updateResultUI({ baseSalaryTotal, totalMonths, attendRate, perfRate, sumRates, serviceRate, specialMoney, perfectAttendanceBonus, deductions, netBonus }, calculationData);
                
                // RENDER CHARTS
                this.renderCharts({ grossBonus, specialMoney, perfectAttendanceBonus, absentDeduct, lateDeduct, warningDeduct, suspendDeduct });

                this.silentClear();
                this.showResult();
            },

            updateResultUI(res, sourceData) {
                const d = sourceData || this.data;
                document.getElementById('final-bonus-display').innerText = res.netBonus.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('base-salary-display').innerText = res.baseSalaryTotal.toLocaleString();
                document.getElementById('total-months-display').innerText = res.totalMonths.toFixed(2);
                document.getElementById('attend-rate-display').innerText = res.attendRate.toFixed(2);
                document.getElementById('attend-detail').innerText = `(${d.leaveDays} ‡∏ß‡∏±‡∏ô)`;
                document.getElementById('perf-rate-display').innerText = res.perfRate.toFixed(2);
                document.getElementById('perf-detail').innerText = `(Grade ${d.grade})`;
                document.getElementById('sum-rate-display').innerText = res.sumRates.toFixed(2);
                document.getElementById('service-rate-display').innerText = `x ${res.serviceRate.toFixed(2)}`;
                document.getElementById('service-date-detail').innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: ${new Date(d.startDate).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'})}`;
                document.getElementById('special-money-display').innerText = res.specialMoney.toLocaleString();

                const perfRow = document.getElementById('perfect-attendance-row');
                if (res.perfectAttendanceBonus > 0) {
                    perfRow.classList.remove('hidden'); perfRow.classList.add('flex');
                    document.getElementById('perfect-attendance-display').innerText = res.perfectAttendanceBonus.toLocaleString();
                } else { perfRow.classList.add('hidden'); perfRow.classList.remove('flex'); }

                const listEl = document.getElementById('deductions-list');
                listEl.innerHTML = '';
                if (res.deductions.length === 0) {
                    listEl.innerHTML = '<div class="text-slate-400 text-sm italic py-2 text-center bg-slate-50 rounded-lg">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å -</div>';
                } else {
                    res.deductions.forEach(d => {
                        listEl.innerHTML += `<div class="flex justify-between items-center text-sm text-rose-600 bg-rose-50 px-3 py-2 rounded-lg border border-rose-100"><span class="font-medium">${d.label}</span><span class="font-bold">-${d.amount.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0})}</span></div>`;
                    });
                }
            },

            // --- CHART RENDERING ---
            renderCharts(data) {
                // Destroy old charts if exist
                if (this.charts['composition']) this.charts['composition'].destroy();
                if (this.charts['deduction']) this.charts['deduction'].destroy();

                // 1. Composition Chart (Doughnut)
                const ctxComp = document.getElementById('compositionChart').getContext('2d');
                this.charts['composition'] = new Chart(ctxComp, {
                    type: 'doughnut',
                    data: {
                        labels: ['‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô', '‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô'],
                        datasets: [{
                            data: [data.grossBonus, data.specialMoney, data.perfectAttendanceBonus],
                            backgroundColor: ['#1369a9', '#10b981', '#f59e0b'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: 'Sarabun' } } },
                            tooltip: { callbacks: { label: (context) => ` ${context.label}: ${context.raw.toLocaleString()} ‡∏ö‡∏≤‡∏ó` } }
                        },
                        cutout: '70%'
                    }
                });

                // 2. Deduction Chart (Bar)
                const totalDeductions = data.absentDeduct + data.lateDeduct + data.warningDeduct + data.suspendDeduct;
                const noDeductMsg = document.getElementById('no-deduction-msg');
                const deductCanvas = document.getElementById('deductionChart');

                if (totalDeductions === 0) {
                    deductCanvas.style.display = 'none';
                    noDeductMsg.classList.remove('hidden');
                } else {
                    deductCanvas.style.display = 'block';
                    noDeductMsg.classList.add('hidden');
                    const ctxDeduct = deductCanvas.getContext('2d');
                    this.charts['deduction'] = new Chart(ctxDeduct, {
                        type: 'bar',
                        data: {
                            labels: ['‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô', '‡∏°‡∏≤‡∏™‡∏≤‡∏¢', '‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô'],
                            datasets: [{
                                label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å (‡∏ö‡∏≤‡∏ó)',
                                data: [data.absentDeduct, data.lateDeduct, data.warningDeduct, data.suspendDeduct],
                                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#64748b'],
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: (context) => ` -${context.raw.toLocaleString()} ‡∏ö‡∏≤‡∏ó` } }
                            },
                            scales: {
                                y: { beginAtZero: true, grid: { display: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            },

            showResult() {
                this.hideAllPages();
                document.getElementById('page-result').classList.remove('hidden');
                document.querySelector('main').scrollTo(0, 0);
            },

            showInput() {
                this.hideAllPages();
                document.getElementById('page-input').classList.remove('hidden');
                document.querySelector('main').scrollTo(0, 0);
                setTimeout(() => { const salInput = document.getElementById('salary'); if(salInput) salInput.focus(); }, 100);
            },
            
            showSettings() {
                this.populateSettingsForm();
                this.hideAllPages();
                document.getElementById('page-settings').classList.remove('hidden');
                document.querySelector('main').scrollTo(0, 0);
            },

            showHistory() {
                this.renderHistory();
                this.hideAllPages();
                document.getElementById('page-history').classList.remove('hidden');
                document.querySelector('main').scrollTo(0, 0);
            },

            hideAllPages() {
                ['page-input', 'page-result', 'page-settings', 'page-history'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>


